<svelte:window on:scroll=handleScroll() />
<svelte:head>
  <link
    rel="prefetch"
    href="/icons-{devicePixelRatio > 1 ? 2 : 1}x.png"
  >
</svelte:head>

<ul>
  {#each $reports as report}
  {#if $closed || report.open}
  {#if !$application || report.body._productName === $application}
  <li data-is-open={report.open}>
    <a href="/reports/{report.id}">
      <div class="id">
        <span>#</span>{report.id}
      </div>

      <div>
        <div class="name">
          {report.body._productName || ""}
        </div>

        <div class="version">
          {#if report.body._version}
          v{report.body._version}
          {/if}
        </div>
      </div>
    </a>
  </li>
  {/if}
  {/if}
  {/each}
</ul>

<script type="module">
/* global document fetch window */
import debounce from "sb-debounce";

const limit = 30;
const offset = 0;

export default {
  data: () => ({
    devicePixelRatio: 1,
    eol: false,
    limit,
    offset,
  }),

  methods: {
    handleScroll: debounce(async function scroller() {
      const { eol } = this.get();
      const { clientHeight, scrollHeight } = document.documentElement;
      const { pageYOffset } = window;

      if (!eol && scrollHeight - (pageYOffset + clientHeight) < 500) {
        this.set({ offset: this.get().offset + limit });

        try {
          const response = await fetch(
            `reports.json?limit=${limit}&offset=${this.get().offset}`
          );
          const reports = await response.json();

          this.set({ eol: !reports.length });
          return this.store.set({
            reports: [...this.store.get().reports, ...reports],
          });
        } catch (error) {
          console.error(error);
          throw error;
        }
      } else {
        return null;
      }
    }, 150),
  },

  oncreate() {
    const { reports } = this.get();

    this.store.set({ reports });

    if (process.browser) {
      this.set({ devicePixelRatio: window.devicePixelRatio });
    }
  },

  async preload() {
    try {
      const response = await this.fetch(
        `reports.json?limit=${limit}&offset=${offset}`
      );
      const reports = await response.json();
      return { reports };
    } catch (error) {
      console.error(error);
      throw error;
    }
  },
};
</script>

<style>
ul {
  list-style-type: none;
}

li:not(:last-child) {
  border-bottom: 1px solid #e0e0e0;
}

a {
  display: flex;
  align-items: center;
  padding: 1.25rem 1rem;
  font-size: 1.25em;
  color: #212121;
  text-decoration: none;
}

a span {
  font-weight: 300;
}

a > div:first-child {
  width: 100%;
}

a > div:last-child {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.id {
  font-weight: 500;
}

.name {
  margin-right: 0.5rem;
}

.name,
.version {
  font-size: 1rem;
  font-weight: 300;
}

[data-is-open="false"],
[data-is-open="false"] a {
  color: #616161;
  background-color: #eee;
}

[data-is-open="false"] .id {
  font-weight: 400;
}
</style>
